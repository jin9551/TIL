# Redis와 캐시

## 캐시(Cache), 캐싱(Caching)이란?

#### 캐시(Cache)란?
캐시란 원본 저장소보다 빠르게 가져올 수 있는 임시 데이터 저장소를 의미한다.

#### 캐싱(Caching)이란?
캐싱이란 캐시(Cache, 임시 데이터 저장소)에 접근해서 데이터를 빠르게 가져오는 방식을 의미한다.


현업에서는 아래와 같이 얘기하는 편이다.

> "이 API는 응답 속도가 너무 느린데? 이 응답 데이터는 **캐싱**을 해두고 쓰는 게 어때?"

이 말을 풀어서 설명하자면 'API 응답 결과를 원본 저장소보다 빠르게 가져올 수 있는 임시 데이터 저장소에 저장해 두고, __빠르게 조회할 수 있게 만드는게 어때__?'라는 의미이다.


* * * 


## 데이터를 캐싱할 때 사용하는 전략 (Cache Aside, Write Around)

> 레디스를 캐시로 쓸 때 어떤 방식으로 사용할 지 전략이 다양하다. 나는 이 중에서 가장 많이 사용되고 있는 전략 2가지를 적어보겠다.

### Cache Aside(= Look Aside, Lazy Loading) 전략

데이터를 조회할 때 주로 사용하는 전략이 **Cache Aside** 전략이다. Look Aside 전략 또는 Lazy Loading 전략이라고 부른다.

이 전략이 어떤 식으로 작동하는지 하나의 예시를 들어 보겠다.

처음으로 게시판 서비스를 배포했다고 가정하고 Cache Aside 작동 방식을 설명하겠다.

1. 처음 게시판 서비스를 배포했기 때문에 데이터베이스와 레디스에는 아무런 데이터도 저장이 안 되어 있다.
2. 일부 사용자가 들어와 게시글 작성을 함으로써 데이터를 저장한다. 이 데이터는 데이터베이스에 저장된다.(레디스에는 저장되지 않는다.)
3. 사용자가 데이터를 조회하려고 요청한다. 이 때, 데이터베이스로부터 바로 데이터를 조회를 하기 전에 레디스에 있는지 먼저 확인한다.
4. **레디스에 데이터가 없는 걸 확인(Cahce Miss)**한 뒤에 데이터베이스로부터 데이터를 조회해서 응답한다.
5. 데이터베이스로부터 조회한 데이터를 응답한 뒤에 레디스에도 데이터를 저장해둔다.
6. 다시 한 번 사용자가 데이터를 조회하려고 요청한다.
7. 레디스에 조회하고자 하는 데이터가 있는지 확인했더니, **데이터가 존재(Cache Hit)**해서 레디스로부터 데이터를 바로 가져와버린다.


> Cache Aside는 간단히 말해서 **캐시에서 데이터를 확인하고, 없다면 DB를 통해 조회해 오는 방식**이다.


## Write Around 전략

> Write Around 전략은 데이터를 어떻게 쓸지(저장, 수정, 삭제)에 대한 전략이다. Write Around 전략은 Cache Aside 전략과 같이 자주 활용되는 전략이다.

Write Around 전략이 어떤 방식인지 '저장'의 예시로 알아보자


```
            +---  레디스
어플리케이션 ㅓ
            +---> 데이터베이스  // 1. 데이터 저장
```

Write Around 전략은 생각보다 간단하다. 데이터를 저장할 때는 레디스에 저장하지 않고 데이터베이스에만 저장하는 방식이다. 그러나 데이터를 조회할 때 레디스에 데이터가 없으면 데이터베이스로부터 데이터를 조회해와서 레디스에 저장시켜주는 방식이다.

> Write Around는 **쓰기 작업(저장, 수정, 삭제)을 캐시에는 반영하지 않고, DB에만 반영**하는 방식을 뜻한다.



* * *


## Cache Aside, Write Around의 한계점과 해결 방법

### Cache Aside, Write Around의 한계점

1. 캐시된 데이터와 DB 데이터가 일치하지 않을 수 있다.

Cache Aside와 Write Around 전략을 같이 썼을 때 한계점 중 하나는 **캐시된 데이터와 DB 데이터가 일치하지 않을 수 있다**는 점이다. 다르게 말하자면 **데이터의 일관성을 보장할 수 없다**는 뜻이다.

Write Around 전략에 따르면 데이터를 수정하 때 DB만 업데이트를 시키기 떄문에 기존에 저장된 레디스 데이터 값과 DB의 데이터 값은 다를 수 밖에 없다.

2. 캐시에 저장할 수 있는 공간이 비교적 작다.

DB는 디스크에 저장해서 많은 양을 저장하기 용이하지만, 캐시는 메모리에 저장하기 때문에 DB에 비해 많은 양의 데이터를 저정할 수가 없다.


### 해결 방법

1. 일관성 해결

캐시와 DB의 데이터를 일치시키기 위해, 데이터를 수정할 때마다 동시에 업데이트를 시키면 성능적으로 느려진다. 그렇다고 성능 향상을 위해 DB의 데이터만 업데이트를 시키면 캐시와 DB의 데이터가 일치하지 않게 된다.

어쩔 수 없지만 어떤 선택을 하든 기회 비용(Trade Off)이 발생한다. 무언가를 얻으면 무언가를 포기해야 한다. 대부분의 개발 기술들이 장점이 있으면 단점이 있다. 따라서 데이터 조회 성능 개선 목적으로 레디스를 쓰는 경우에는 데이터의 일관성을 포기하고 성능 향상을 택한 것이다.

위와 같은 사유로 인해 캐시를 적용시키기에는 적절한 데이터는 다음과 같다 :
* 자주 조회되는 데이터
* 잘 변하지 않는 데이터
* 실시간으로 정확하게 일치하지 않아도 되는 데이터

하지만 장기간 데이터가 일치하지 않는 건 문제가 될 수 있다. 따라서 적절한 주기로 데이터를 동기화시켜주어여 한다. 이 때 활용하는 기능이 레디스의 **TTL**기능이다.

일정 시간이 지나면 데이터가 캐시에서 삭제된다. 그럼 특정 사용자가 조회를 하는 순간 Cache Miss가 발생한다. DB의 데이터를 새로 조회해와서 캐시에 데이터를 저장하게 된다. 즉, 데이터가 갱신되는 것이다.


2. 캐시 저장 공간 부족

TTL 기능을 활용하면 캐시의 공간을 효율적으로 쓸 수 있다. 왜냐면 자주 조회하지 않는 데이터는 만료 시간에 의해 데이터가 삭제되기 때문이다.


> Cache Aside와 Write Around 전략을 사용할 때 TTL을 같이 활용해야 한다.